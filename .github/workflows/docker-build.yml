name: Build & Deploy Wisecow with ngrok

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ Checkout repository
    - name: Checkout code
      uses: actions/checkout@v3

    # 2ï¸âƒ£ Set up Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 3ï¸âƒ£ Login to Docker Hub
    - name: Docker login
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 4ï¸âƒ£ Build Docker image
    - name: Build Docker image
      run: docker build -t sabarisurya/wisecow:latest .

    # 5ï¸âƒ£ Push Docker image
    - name: Push Docker image
      run: docker push sabarisurya/wisecow:latest

    # 6ï¸âƒ£ Install kubectl
    - name: Install kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.27.4'

    # 7ï¸âƒ£ Install kind
    - name: Install kind
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind

    # 8ï¸âƒ£ Create kind cluster
    - name: Create kind cluster
      run: kind create cluster --name wisecow-cluster

    # 9ï¸âƒ£ Load Docker image into kind
    - name: Load Docker image into kind
      run: kind load docker-image sabarisurya/wisecow:latest --name wisecow-cluster

    # ðŸ”Ÿ Deploy Wisecow manifests
    - name: Deploy Wisecow
      run: |
        # Create TLS secret (skip if exists)
        kubectl create secret tls wisecow-tls --cert=tls.crt --key=tls.key || true

        # Apply deployment and service
        kubectl apply -f wisecow-deployment.yaml
        kubectl apply -f wisecow-service.yaml

        # Optional: skip Ingress in GitHub Actions
        # kubectl apply -f wisecow-ingress.yaml || true

        # Update deployment image
        kubectl set image deployment/wisecow wisecow=sabarisurya/wisecow:latest

        # Wait a bit for pods to start
        sleep 30

        # Debug pods
        kubectl get pods -o wide
        kubectl logs -l app=wisecow

    # 11ï¸âƒ£ Install ngrok
    - name: Install ngrok
      run: |
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update && sudo apt install ngrok -y

    # 12ï¸âƒ£ Start ngrok tunnel with auth token
    - name: Start ngrok tunnel
      run: |
        ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        nohup ngrok http 4499 --log=stdout > ngrok.log &
        sleep 10
        NGROK_URL=$(grep -o 'https://[0-9a-z]*\.ngrok.io' ngrok.log | head -n1)
        echo "Wisecow app is live at: $NGROK_URL"
